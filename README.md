
原文出处：[十年踪迹](https://www.h5jun.com/post/how-to-write-better-js-code.html)

![](https://p3.ssl.qhimg.com/t0111abe7db051d82e7.jpg)

实现一个类似于“交通灯”的效果，让三个不同颜色的圆点每隔 2 秒循环切换。
那么这一功能的 JavaScript 该如何实现呢？
![](http://i.imgur.com/Uc9I8Yc.gif)
# 版本一 定时器嵌套#
问题：

1. 首先是过程耦合，状态切换是wait->stop->pass 循环，在上面的设计里，实际上操作顺序是耦合在一起的，要先 ‘wait’，然后等待 2000 毫秒再 ‘stop’，然后再等待 2000 毫秒在 ‘pass’，这中间的顺序一旦有调整，需求有变化，代码都需要修改。

2. 其次，这样的异步嵌套是会产生 callback hell 的，如果需求不是三盏灯，而是五盏灯、十盏灯，代码的嵌套结构就很深，看起来就很难看了。

# 版本二 数据抽象#

要解决版本一的过程耦合问题，最简单的思路是将状态['wait','stop','pass']抽象出来：


# 版本三 良好封装#

版本三是中规中矩的一版，也是一般我们在工作中比较常用的思路。应该将暴露出来的 API 暴露出来（本例中的 stateList）。将不应该暴露出来的数据或状态隐藏（本例中的 currentStateIndex）。

有许多同学觉得说写出这一版本来已经很不错的。的确，应该也还不错，但这一版的抽象程度其实也不是很高，或者说，如果考虑适用性，这版已经很好了，但是如果考虑可复用性的话，这版依然有改进空间。

# 版本四 过程抽象#

这一版用的是过程抽象的思路，而过程抽象，是函数式编程的基础。在这里，我们抽象出了一个 poll(...fnList) 的高阶组合函数，它将一个函数列表组合起来，每次调用时依次轮流执行列表里的函数。


# 版本五 需求升级#

版本五的思路是，既然我们需要考虑不同的持续时间，那么我们需要将等待时间抽象出来：

# 版本5.1 更加易读#

把Promise改成async和await


# 版本六 我放大招了#

进一步抽象，设计出版本六，或者类似的对象模型


经验：js文件要写到body标签底部，，不然js先执行的话，dom树还来不及渲染，，导致报错喔“ 	
	cannot set property 'classname' of null